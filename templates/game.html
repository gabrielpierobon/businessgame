{% extends "base.html" %}

{% block title %}Business Game - Quarter {{ game.current_quarter }}{% endblock %}

{% block head %}
<style>
    .metric-card {
        height: 100%;
    }
    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .metric-label {
        font-size: 0.9rem;
        color: #6c757d;
    }
    .chart-container {
        height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1>Business Game - Quarter {{ game.current_quarter }}</h1>
        <p class="lead">Make strategic decisions for your manufacturing company</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="d-flex flex-column align-items-end">
            <h3 class="mb-0">{{ game.stock_price }}</h3>
            <span class="text-muted">Stock Price</span>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card metric-card">
            <div class="card-body">
                <h5 class="card-title">Company Financials</h5>
                <div class="row mt-3">
                    <div class="col-6">
                        <div class="metric-label">Cash</div>
                        <div class="metric-value">{{ game.cash }}</div>
                    </div>
                    <div class="col-6">
                        <div class="metric-label">Assets</div>
                        <div class="metric-value">{{ game.assets }}</div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-6">
                        <div class="metric-label">Revenue</div>
                        <div class="metric-value">{{ game.revenue }}</div>
                    </div>
                    <div class="col-6">
                        <div class="metric-label">Profit</div>
                        <div class="metric-value">{{ game.profit }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card metric-card">
            <div class="card-body">
                <h5 class="card-title">Production</h5>
                <div class="row mt-3">
                    <div class="col-6">
                        <div class="metric-label">Inventory</div>
                        <div class="metric-value">{{ game.inventory }}</div>
                    </div>
                    <div class="col-6">
                        <div class="metric-label">Capacity</div>
                        <div class="metric-value">{{ game.capacity }}</div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-6">
                        <div class="metric-label">Costs</div>
                        <div class="metric-value">{{ game.costs }}</div>
                    </div>
                    <div class="col-6">
                        <div class="metric-label">Tax Rate</div>
                        <div class="metric-value">{{ game.tax_rate }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card metric-card">
            <div class="card-body">
                <h5 class="card-title">Market</h5>
                <div class="row mt-3">
                    <div class="col-6">
                        <div class="metric-label">Market Size</div>
                        <div class="metric-value">{{ game.market_size }}</div>
                    </div>
                    <div class="col-6">
                        <div class="metric-label">Growth</div>
                        <div class="metric-value">{{ game.market_growth }}</div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-6">
                        <div class="metric-label">Your Share</div>
                        <div class="metric-value">{{ game.player_market_share }}</div>
                    </div>
                    <div class="col-6">
                        <div class="metric-label">Competitor Price</div>
                        <div class="metric-value">{{ game.competitor_price }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Performance History</h5>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 offset-md-3">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Quarterly Decisions</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/games/{{ game.game_id }}/actions">
                    <div class="mb-3">
                        <label for="price" class="form-label">Product Price</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="price" name="price" value="100.0" step="0.1" min="50.0" required>
                        </div>
                        <div class="form-text">Set your product price. Competitor price is {{ game.competitor_price }}</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="production_volume" class="form-label">Production Volume</label>
                        <input type="number" class="form-control" id="production_volume" name="production_volume" value="500" step="10" min="0" max="{{ game.capacity.split(' ')[0] | int }}" required>
                        <div class="form-text">Set production volume for the quarter (0-{{ game.capacity }})</div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Submit Decisions</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Parse chart data from server
    const chartData = {{ chart_data | safe }};
    
    // Create performance chart
    const ctx = document.getElementById('performanceChart').getContext('2d');
    const performanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.quarters.map(q => `Q${q}`),
            datasets: [
                {
                    label: 'Revenue',
                    data: chartData.revenue,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.1
                },
                {
                    label: 'Profit',
                    data: chartData.profit,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                },
                {
                    label: 'Stock Price',
                    data: chartData.stock_price,
                    borderColor: 'rgba(153, 102, 255, 1)',
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    tension: 0.1,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Revenue/Profit (millions)'
                    }
                },
                y1: {
                    beginAtZero: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Stock Price ($)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
</script>
{% endblock %} 